<!DOCTYPE html>
<html class="writer-html5" lang="hpopt" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detection with OTE &mdash; hpopt 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Classification with OTE" href="cls_tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> hpopt
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">What is hpopt?</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started with hpopt</a></li>
<li class="toctree-l1"><a class="reference internal" href="using.html">Using hpopt</a></li>
<li class="toctree-l1"><a class="reference internal" href="apis.html">HpOpt API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Flowcharts:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="flowchart.html">Flowchart</a></li>
<li class="toctree-l1"><a class="reference internal" href="standard.html">Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="pause.html">Pause / Resume</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HPO_OTE:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="hpo_ote.html">HPO with OTE</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpo_config.html">How to write hpo_config.yaml</a></li>
<li class="toctree-l1"><a class="reference internal" href="cls_tutorial.html">Classification with OTE</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Detection with OTE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#set-hpo-config-yaml">1. Set hpo_config.yaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-ote">2. Run OTE</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resume-reuse-hpo">3. Resume &amp; Reuse HPO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optional-hyper-parameterse-analysis">4. (Optional) Hyper parameterse analysis</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">hpopt</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Detection with OTE</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/contents/det_tutorial.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="detection-with-ote">
<h1>Detection with OTE<a class="headerlink" href="#detection-with-ote" title="Permalink to this heading"></a></h1>
<p>This tutorial provide you how to use HPO for detection.
We'll optimize learning rate and batch size in this tutorial using SMBO which is common method for HPO.</p>
<p>Let's take a look at how HPO can be executed in OTE step by step.</p>
<section id="set-hpo-config-yaml">
<h2>1. Set hpo_config.yaml<a class="headerlink" href="#set-hpo-config-yaml" title="Permalink to this heading"></a></h2>
<p>Before running HPO, you should configure HPO using <strong>hpo_config.yaml</strong>.
It configures everything HPO module needs from hyper parameters you'll optimize to which algorithm to use for HPO.
For more information, you can refer <a class="reference internal" href="hpo_config.html"><span class="doc"></span></a>.
Actually, there is already hpo_config.yaml file with default value in directory where <em>template.yaml</em> resides.</p>
<p>Here is default hpo_config.yaml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">metric</span><span class="p">:</span> <span class="n">mAP</span>
<span class="n">search_algorithm</span><span class="p">:</span> <span class="n">smbo</span>
<span class="n">early_stop</span><span class="p">:</span> <span class="kc">None</span>
<span class="n">hp_space</span><span class="p">:</span>
  <span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">:</span>
    <span class="n">param_type</span><span class="p">:</span> <span class="n">quniform</span>
    <span class="nb">range</span><span class="p">:</span> 
      <span class="o">-</span> <span class="mf">0.001</span>
      <span class="o">-</span> <span class="mf">0.1</span>
      <span class="o">-</span> <span class="mf">0.001</span>
  <span class="n">learning_parameters</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
    <span class="n">param_type</span><span class="p">:</span> <span class="n">qloguniform</span>
    <span class="nb">range</span><span class="p">:</span>
      <span class="o">-</span> <span class="mi">4</span>
      <span class="o">-</span> <span class="mi">8</span>
      <span class="o">-</span> <span class="mi">2</span>
</pre></div>
</div>
<p>We can just use this for HPO, but It seems that there is no need to set learning rate search space such that widely.
So, let's modify configuration slightly now.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
  <span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">:</span>
    <span class="n">param_type</span><span class="p">:</span> <span class="n">quniform</span>
    <span class="nb">range</span><span class="p">:</span> 
      <span class="o">-</span> <span class="mf">0.001</span>
      <span class="o">-</span> <span class="mf">0.01</span>
      <span class="o">-</span> <span class="mf">0.001</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
</pre></div>
</div>
<p>It looks good. As you see, you can easily change search space or even hyper parameter to optimize by just modifying hpo_config.yaml.</p>
</section>
<section id="run-ote">
<h2>2. Run OTE<a class="headerlink" href="#run-ote" title="Permalink to this heading"></a></h2>
<p>Now it's time to run OTE. You can enable HPO by just adding an argument <strong>--enable-hpo</strong> literally.
Oops! I forget that we don't have much time to use for HPO.
It would be enough to use same time as training to execute HPO (default hpo-time-ratio is 4).
In this case, you can just add one argument <strong>--hpo-time-ratio</strong> and set it 2.
It means that twice as much time is used as only training time.</p>
<div class="highlight-{note} notranslate"><div class="highlight"><pre><span></span>You should install OTE detection before running OTE.
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ote</span> <span class="n">train</span> \
    <span class="n">training_extensions</span><span class="o">/</span><span class="n">external</span><span class="o">/</span><span class="n">mmdetection</span><span class="o">/</span><span class="n">configs</span><span class="o">/</span><span class="n">ote</span><span class="o">/</span><span class="n">custom</span><span class="o">-</span><span class="nb">object</span><span class="o">-</span><span class="n">detection</span><span class="o">/</span><span class="n">gen3_mobilenetV2_ATSS</span><span class="o">/</span><span class="n">template</span><span class="o">.</span><span class="n">yaml</span> \
    <span class="o">--</span><span class="n">train</span><span class="o">-</span><span class="n">ann</span><span class="o">-</span><span class="n">files</span> <span class="n">training_extensions</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">airport</span><span class="o">/</span><span class="n">annotation_example_train</span><span class="o">.</span><span class="n">json</span> \
    <span class="o">--</span><span class="n">train</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">roots</span> <span class="n">training_extensions</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">airport</span><span class="o">/</span><span class="n">train</span> \
    <span class="o">--</span><span class="n">val</span><span class="o">-</span><span class="n">ann</span><span class="o">-</span><span class="n">files</span> <span class="n">training_extensions</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">airport</span><span class="o">/</span><span class="n">annotation_example_val</span><span class="o">.</span><span class="n">json</span> \
    <span class="o">--</span><span class="n">val</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">roots</span> <span class="n">training_extensions</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">airport</span><span class="o">/</span><span class="n">val</span> \
    <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">to</span> <span class="n">training_extensions</span><span class="o">/</span><span class="n">best</span><span class="o">.</span><span class="n">pth</span> \
    <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">hpo</span> \
    <span class="o">--</span><span class="n">hpo</span><span class="o">-</span><span class="n">time</span><span class="o">-</span><span class="n">ratio</span> <span class="mi">2</span>
</pre></div>
</div>
<p>That's it. Now HPO is automatically set to use twice time.
As you can see, you can just add <em>--hpo-time-ratio</em> argument to set how much time to use for HPO.</p>
<p>After HPO, HPO result is printed as bellow. You can see which parameter is chosen by this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span>  <span class="c1">#  | learning_parameters.learning_rate  | learning_parameters.batch_size  |        score        |</span>
<span class="o">|</span>   <span class="mi">1</span> <span class="o">|</span>                              <span class="mf">0.005</span> <span class="o">|</span>                               <span class="mi">8</span> <span class="o">|</span>  <span class="mf">0.6179835230685988</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">2</span> <span class="o">|</span>                              <span class="mf">0.005</span> <span class="o">|</span>                              <span class="mi">10</span> <span class="o">|</span>  <span class="mf">0.5103616463460058</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">3</span> <span class="o">|</span>                               <span class="mf">0.01</span> <span class="o">|</span>                              <span class="mi">48</span> <span class="o">|</span>  <span class="mf">0.6613380273927504</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">4</span> <span class="o">|</span>                              <span class="mf">0.006</span> <span class="o">|</span>                              <span class="mi">16</span> <span class="o">|</span>  <span class="mf">0.4305718659552452</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">5</span> <span class="o">|</span>                              <span class="mf">0.002</span> <span class="o">|</span>                              <span class="mi">36</span> <span class="o">|</span>  <span class="mf">0.5250386319610906</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">6</span> <span class="o">|</span>               <span class="mf">0.009000000000000001</span> <span class="o">|</span>                              <span class="mi">30</span> <span class="o">|</span>  <span class="mf">0.7129637650433698</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">7</span> <span class="o">|</span>                              <span class="mf">0.003</span> <span class="o">|</span>                              <span class="mi">44</span> <span class="o">|</span>  <span class="mf">0.9165404011276648</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">8</span> <span class="o">|</span>                               <span class="mf">0.01</span> <span class="o">|</span>                              <span class="mi">42</span> <span class="o">|</span>  <span class="mf">0.8234693648419807</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">9</span> <span class="o">|</span>                              <span class="mf">0.006</span> <span class="o">|</span>                               <span class="mi">8</span> <span class="o">|</span>  <span class="mf">0.6856121908185698</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">10</span> <span class="o">|</span>                              <span class="mf">0.005</span> <span class="o">|</span>                              <span class="mi">30</span> <span class="o">|</span>  <span class="mf">0.8736238451806234</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">11</span> <span class="o">|</span>                              <span class="mf">0.005</span> <span class="o">|</span>                              <span class="mi">44</span> <span class="o">|</span>  <span class="mf">0.7295280110191358</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">12</span> <span class="o">|</span>                              <span class="mf">0.004</span> <span class="o">|</span>                              <span class="mi">28</span> <span class="o">|</span>  <span class="mf">0.9178114717365546</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">13</span> <span class="o">|</span>                              <span class="mf">0.002</span> <span class="o">|</span>                              <span class="mi">44</span> <span class="o">|</span>  <span class="mf">0.8877622967705454</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">14</span> <span class="o">|</span>                              <span class="mf">0.003</span> <span class="o">|</span>                              <span class="mi">28</span> <span class="o">|</span>  <span class="mf">0.6154036330149992</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">15</span> <span class="o">|</span>                              <span class="mf">0.002</span> <span class="o">|</span>                              <span class="mi">18</span> <span class="o">|</span>  <span class="mf">0.6622151844713957</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">16</span> <span class="o">|</span>                              <span class="mf">0.007</span> <span class="o">|</span>                              <span class="mi">24</span> <span class="o">|</span>  <span class="mf">0.7678530317224548</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">17</span> <span class="o">|</span>                              <span class="mf">0.003</span> <span class="o">|</span>                              <span class="mi">22</span> <span class="o">|</span>  <span class="mf">0.8609778838120822</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">18</span> <span class="o">|</span>                              <span class="mf">0.004</span> <span class="o">|</span>                              <span class="mi">44</span> <span class="o">|</span>  <span class="mf">0.8966648842324036</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">19</span> <span class="o">|</span>                              <span class="mf">0.005</span> <span class="o">|</span>                              <span class="mi">28</span> <span class="o">|</span>  <span class="mf">0.8302362663067738</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">20</span> <span class="o">|</span>                              <span class="mf">0.005</span> <span class="o">|</span>                              <span class="mi">36</span> <span class="o">|</span>  <span class="mf">0.5476845047852292</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">21</span> <span class="o">|</span>                              <span class="mf">0.003</span> <span class="o">|</span>                              <span class="mi">48</span> <span class="o">|</span>  <span class="mf">0.7321795851958944</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">22</span> <span class="o">|</span>                               <span class="mf">0.01</span> <span class="o">|</span>                              <span class="mi">34</span> <span class="o">|</span>  <span class="mf">0.9057167695385367</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">23</span> <span class="o">|</span>                              <span class="mf">0.008</span> <span class="o">|</span>                              <span class="mi">34</span> <span class="o">|</span>  <span class="mf">0.5073170938766568</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">24</span> <span class="o">|</span>                              <span class="mf">0.006</span> <span class="o">|</span>                              <span class="mi">30</span> <span class="o">|</span>  <span class="mf">0.8442392588571863</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">25</span> <span class="o">|</span>               <span class="mf">0.009000000000000001</span> <span class="o">|</span>                              <span class="mi">12</span> <span class="o">|</span>  <span class="mf">0.9121951985354356</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">26</span> <span class="o">|</span>                               <span class="mf">0.01</span> <span class="o">|</span>                              <span class="mi">12</span> <span class="o">|</span>  <span class="mf">0.6068545610227464</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">27</span> <span class="o">|</span>                              <span class="mf">0.002</span> <span class="o">|</span>                              <span class="mi">10</span> <span class="o">|</span>   <span class="mf">0.701241262917842</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">28</span> <span class="o">|</span>                              <span class="mf">0.002</span> <span class="o">|</span>                              <span class="mi">20</span> <span class="o">|</span>  <span class="mf">0.9062640968219959</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">29</span> <span class="o">|</span>                               <span class="mf">0.01</span> <span class="o">|</span>                              <span class="mi">60</span> <span class="o">|</span>  <span class="mf">0.5049643461876376</span> <span class="o">|</span>
<span class="n">Best</span> <span class="n">Hyper</span><span class="o">-</span><span class="n">parameters</span>
<span class="p">{</span><span class="s1">&#39;learning_parameters.batch_size&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="s1">&#39;learning_parameters.learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.004</span><span class="p">}</span>
</pre></div>
</div>
<p>Then, model is trained with these parameters HPO found.
Now what you need to do is just waiting until all tasks is done.</p>
</section>
<section id="resume-reuse-hpo">
<h2>3. Resume &amp; Reuse HPO<a class="headerlink" href="#resume-reuse-hpo" title="Permalink to this heading"></a></h2>
<p>You may want to resume HPO after HPO stopped in the middle or reuse hyper parameters HPO found before.
In this case, you can just run OTE same as above.
Then, HPO module automatically searches HPO progress directory(named HPO) used before,
and HPO asks</p>
<ol class="simple">
<li><p>resume in case that HPO is stopped in the middle</p></li>
<li><p>reuse optimized hyper parameter in case that HPO is finished before</p></li>
<li><p>rerun HPO from scratch</p></li>
</ol>
<p>This is convenient feature to save time by skipping unnecessary HPO.</p>
<div class="highlight-{warning} notranslate"><div class="highlight"><pre><span></span>HPO module asks to you only if HPO configurations are set equivalently as before.
When configurations is changed, HPO is excuted without asking.
</pre></div>
</div>
</section>
<section id="optional-hyper-parameterse-analysis">
<h2>4. (Optional) Hyper parameterse analysis<a class="headerlink" href="#optional-hyper-parameterse-analysis" title="Permalink to this heading"></a></h2>
<p>HPO module saves progress of each trials. So you can use it to analyze trend of hyper parameters by yourself.
It's saved in directory named <strong>hpo</strong> in same path where final model weight is saved.</p>
<p>You can see several files like &quot;hpopt_status.json&quot; and &quot;hpopt_trial_#.json&quot; in the directory.
Someone who are clever may already have notices,
first one conatins overall information of HPO progress and second one contains each trials' infomation.</p>
<p>Detail explanations are as bellow.</p>
<ul class="simple">
<li><p>hpopt_status.json</p>
<ul>
<li><p>search_algorithm : Which algorithm used for HPO.</p></li>
<li><p>search_space : Which hyper parameters to optmize and scale and range of each hyper parameters.</p></li>
<li><p>metric : Metric used during HPO.</p></li>
<li><p>subset_ratio : Ratio of train dataset size used for HPO.</p></li>
<li><p>image_resize : Ratio of trainning image used for HPO.</p></li>
<li><p>early_stop : Early stop methods used for SMBO.</p></li>
<li><p>max_iterations : Maximum iterations for HPO trials.</p></li>
<li><p>full_dataset_size : Original train dataset size.</p></li>
<li><p>config_list : List of each trials' information. Each contains trial id, hyper parameters, status and score.</p></li>
<li><p>num_gen_config : Total number of trials.</p></li>
<li><p>best_config_id : Trial id containing best score.</p></li>
</ul>
</li>
<li><p>hpopt_trial_#.json : This file contains status and each iteration's score.</p></li>
</ul>
<p>By these information, you can manually decide which hyper parameters to use.
Because these files have json format, you can easily load these files from other application.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cls_tutorial.html" class="btn btn-neutral float-left" title="Classification with OTE" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, intel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>